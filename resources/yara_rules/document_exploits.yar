/*
    Document Exploit Detection Rules
    Malicious documents, macros, and embedded exploits
*/

rule Doc_Macro_AutoExec {
    meta:
        description = "Auto-executing macro document"
        severity = "high"
    strings:
        $ole = { D0 CF 11 E0 A1 B1 1A E1 }
        $vba = "VBA" ascii
        $auto1 = "AutoOpen" ascii
        $auto2 = "Auto_Open" ascii
        $auto3 = "AutoExec" ascii
        $auto4 = "AutoClose" ascii
        $auto5 = "Document_Open" ascii
        $auto6 = "Workbook_Open" ascii
    condition:
        $ole and $vba and (any of ($auto*))
}

rule Doc_Macro_Shell_Exec {
    meta:
        description = "Macro with shell execution"
        severity = "critical"
    strings:
        $ole = { D0 CF 11 E0 }
        $shell1 = "Shell(" ascii
        $shell2 = "WScript.Shell" ascii
        $shell3 = "Shell.Application" ascii
        $exec1 = ".Run" ascii
        $exec2 = ".Exec" ascii
        $exec3 = "CreateObject" ascii
    condition:
        $ole and (any of ($shell*)) and (any of ($exec*))
}

rule Doc_Macro_PowerShell {
    meta:
        description = "Macro launching PowerShell"
        severity = "critical"
    strings:
        $ole = { D0 CF 11 E0 }
        $ps1 = "powershell" ascii nocase
        $ps2 = "pwsh" ascii nocase
        $ps3 = "-enc" ascii
        $ps4 = "-EncodedCommand" ascii nocase
        $ps5 = "bypass" ascii nocase
        $ps6 = "-nop" ascii nocase
    condition:
        $ole and (any of ($ps*))
}

rule Doc_Macro_Download {
    meta:
        description = "Macro downloading content"
        severity = "critical"
    strings:
        $ole = { D0 CF 11 E0 }
        $http1 = "XMLHTTP" ascii
        $http2 = "WinHttp" ascii
        $http3 = "URLDownloadToFile" ascii
        $http4 = "Msxml2.ServerXMLHTTP" ascii
        $http5 = "MSXML2.XMLHTTP" ascii
        $url = "http" ascii nocase
    condition:
        $ole and (any of ($http*)) and $url
}

rule Doc_Macro_Obfuscated {
    meta:
        description = "Obfuscated macro document"
        severity = "high"
    strings:
        $ole = { D0 CF 11 E0 }
        $chr = "Chr(" ascii
        $asc = "Asc(" ascii
        $concat = "&" ascii
        $split = "Split(" ascii
        $replace = "Replace(" ascii
        $strrev = "StrReverse(" ascii
    condition:
        $ole and (3 of ($chr, $asc, $concat, $split, $replace, $strrev))
}

rule Doc_OLE_Embedded {
    meta:
        description = "OLE embedded object"
        severity = "high"
    strings:
        $ole = { D0 CF 11 E0 }
        $embed1 = "Package" ascii
        $embed2 = "OLE2Link" ascii
        $embed3 = "ObjData" ascii
        $exe = ".exe" ascii nocase
        $dll = ".dll" ascii nocase
        $scr = ".scr" ascii nocase
    condition:
        $ole and (any of ($embed*)) and (any of ($exe, $dll, $scr))
}

rule Doc_DDE_Attack {
    meta:
        description = "DDE command execution"
        severity = "critical"
    strings:
        $dde1 = "DDEAUTO" ascii nocase
        $dde2 = "DDE" ascii
        $cmd = "cmd" ascii nocase
        $powershell = "powershell" ascii nocase
        $mshta = "mshta" ascii nocase
    condition:
        (any of ($dde*)) and (any of ($cmd, $powershell, $mshta))
}

rule Doc_RTF_ObjData {
    meta:
        description = "RTF with embedded object"
        severity = "high"
    strings:
        $rtf = "{\\rtf" ascii
        $objdata = "\\objdata" ascii
        $objclass = "\\objclass" ascii
        $objocx = "\\objocx" ascii
        $equation = "Equation" ascii
        $package = "Package" ascii
    condition:
        $rtf and ($objdata or $objclass or $objocx) and (any of ($equation, $package))
}

rule Doc_RTF_CVE_2017_11882 {
    meta:
        description = "RTF Equation Editor exploit (CVE-2017-11882)"
        severity = "critical"
    strings:
        $rtf = "{\\rtf" ascii
        $equation = "Equation" ascii nocase
        $eqnedt = "eqnedt32" ascii nocase
        $exploit = { 02 CE 02 00 }
        $objdata = "\\objdata" ascii
    condition:
        $rtf and (any of ($equation, $eqnedt)) and ($exploit or $objdata)
}

rule Doc_RTF_CVE_2017_0199 {
    meta:
        description = "RTF HTA exploit (CVE-2017-0199)"
        severity = "critical"
    strings:
        $rtf = "{\\rtf" ascii
        $objautlink = "\\objautlink" ascii
        $objupdate = "\\objupdate" ascii
        $objclass = "\\objclass" ascii
        $hta = "hta" ascii nocase
        $script = "script" ascii nocase
    condition:
        $rtf and (any of ($objautlink, $objupdate)) and (any of ($hta, $script))
}

rule Doc_OOXML_Macro {
    meta:
        description = "OOXML document with macro"
        severity = "high"
    strings:
        $pk = { 50 4B 03 04 }
        $content_type = "[Content_Types].xml" ascii
        $vba = "vbaProject.bin" ascii
        $macro = "macroEnabled" ascii nocase
    condition:
        $pk and $content_type and (any of ($vba, $macro))
}

rule Doc_OOXML_External_Link {
    meta:
        description = "OOXML with external reference"
        severity = "high"
    strings:
        $pk = { 50 4B 03 04 }
        $target = "Target=" ascii
        $external = "External" ascii
        $http = "http" ascii nocase
        $smb = "file://" ascii nocase
    condition:
        $pk and $target and ($external or any of ($http, $smb))
}

rule Doc_Template_Injection {
    meta:
        description = "Template injection attack"
        severity = "critical"
    strings:
        $pk = { 50 4B 03 04 }
        $settings = "settings.xml" ascii
        $target = "Target" ascii
        $template = "attachedTemplate" ascii nocase
        $http = "http" ascii nocase
    condition:
        $pk and $settings and ($target or $template) and $http
}

rule Doc_Follina_CVE_2022_30190 {
    meta:
        description = "Follina MSDT exploit"
        severity = "critical"
    strings:
        $pk = { 50 4B 03 04 }
        $msdt = "ms-msdt:" ascii nocase
        $oleobject = "oleObject" ascii
        $http = "http" ascii nocase
        $powershell = "powershell" ascii nocase
    condition:
        $pk and $msdt and (any of ($oleobject, $http, $powershell))
}

rule Doc_XLM_Macro_4 {
    meta:
        description = "Excel 4.0 XLM macro"
        severity = "critical"
    strings:
        $ole = { D0 CF 11 E0 }
        $xlm1 = "=EXEC(" ascii
        $xlm2 = "=CALL(" ascii
        $xlm3 = "=HALT(" ascii
        $xlm4 = "=REGISTER(" ascii
        $xlm5 = "=FORMULA(" ascii
        $auto = "Auto_Open" ascii
    condition:
        $ole and (any of ($xlm*)) and $auto
}

rule Doc_Excel_Formula_Injection {
    meta:
        description = "Excel formula injection"
        severity = "high"
    strings:
        $excel = { D0 CF 11 E0 }
        $formula1 = "=cmd|" ascii
        $formula2 = "=HYPERLINK" ascii
        $formula3 = "@SUM(" ascii
        $dde = "=DDE(" ascii
        $cmd = "cmd.exe" ascii nocase
    condition:
        $excel and (any of ($formula*, $dde)) and $cmd
}

rule Doc_PDF_JavaScript {
    meta:
        description = "PDF with JavaScript"
        severity = "high"
    strings:
        $pdf = "%PDF" ascii
        $js1 = "/JavaScript" ascii
        $js2 = "/JS" ascii
        $openaction = "/OpenAction" ascii
        $eval = "eval" ascii
        $app = "app." ascii
    condition:
        $pdf and (any of ($js*)) and (any of ($openaction, $eval, $app))
}

rule Doc_PDF_Launch_Action {
    meta:
        description = "PDF with launch action"
        severity = "critical"
    strings:
        $pdf = "%PDF" ascii
        $launch = "/Launch" ascii
        $action = "/Action" ascii
        $cmd = "cmd.exe" ascii nocase
        $powershell = "powershell" ascii nocase
    condition:
        $pdf and $launch and ($action or any of ($cmd, $powershell))
}

rule Doc_PDF_Embedded_File {
    meta:
        description = "PDF with embedded file"
        severity = "high"
    strings:
        $pdf = "%PDF" ascii
        $embed1 = "/EmbeddedFile" ascii
        $embed2 = "/FileSpec" ascii
        $stream = "/FlateDecode" ascii
        $exe = ".exe" ascii nocase
        $bat = ".bat" ascii nocase
    condition:
        $pdf and (any of ($embed*)) and ($stream or any of ($exe, $bat))
}

rule Doc_PDF_URI_Action {
    meta:
        description = "PDF with URI action"
        severity = "medium"
    strings:
        $pdf = "%PDF" ascii
        $uri = "/URI" ascii
        $action = "/Action" ascii
        $http = "http" ascii nocase
        $file = "file://" ascii nocase
    condition:
        $pdf and $uri and $action and (any of ($http, $file))
}

rule Doc_OneNote_Embedded {
    meta:
        description = "OneNote with embedded content"
        severity = "high"
    strings:
        $one = { E4 52 5C 7B 8C D8 A7 4D }  // OneNote magic
        $embed = "EmbeddedFile" ascii
        $exe = ".exe" ascii nocase
        $bat = ".bat" ascii nocase
        $cmd = ".cmd" ascii nocase
        $hta = ".hta" ascii nocase
    condition:
        $one and $embed and (any of ($exe, $bat, $cmd, $hta))
}

rule Doc_ISO_IMG_Dropper {
    meta:
        description = "ISO/IMG file dropper"
        severity = "high"
    strings:
        $iso = "CD001" ascii
        $exe = ".exe" ascii nocase
        $lnk = ".lnk" ascii nocase
        $vbs = ".vbs" ascii nocase
        $dll = ".dll" ascii nocase
    condition:
        $iso and (2 of ($exe, $lnk, $vbs, $dll))
}

rule Doc_VHD_Dropper {
    meta:
        description = "VHD file dropper"
        severity = "high"
    strings:
        $vhd = "conectix" ascii  // VHD signature
        $vhdx = "vhdxfile" ascii  // VHDX signature
        $exe = ".exe" ascii nocase
        $dll = ".dll" ascii nocase
    condition:
        (any of ($vhd, $vhdx)) and (any of ($exe, $dll))
}

