/*
    Fileless Malware Detection Rules
    Living-off-the-land, PowerShell, and memory-only attacks
*/

rule Fileless_PowerShell_Download {
    meta:
        description = "PowerShell download cradle"
        severity = "high"
    strings:
        $ps1 = "powershell" ascii nocase
        $dl1 = "DownloadString" ascii
        $dl2 = "DownloadFile" ascii
        $dl3 = "DownloadData" ascii
        $dl4 = "Invoke-WebRequest" ascii
        $dl5 = "wget" ascii
        $dl6 = "curl" ascii
        $dl7 = "Net.WebClient" ascii
        $dl8 = "Start-BitsTransfer" ascii
        $iex = "IEX" ascii
        $invoke = "Invoke-Expression" ascii
    condition:
        $ps1 and (any of ($dl*)) and ($iex or $invoke)
}

rule Fileless_PowerShell_Encoded {
    meta:
        description = "Base64 encoded PowerShell"
        severity = "high"
    strings:
        $enc1 = "-enc" ascii nocase
        $enc2 = "-encodedcommand" ascii nocase
        $enc3 = "-e " ascii nocase
        $enc4 = "-ec " ascii nocase
        $b64 = /[A-Za-z0-9+\/=]{50,}/ ascii
        $ps = "powershell" ascii nocase
    condition:
        $ps and any of ($enc*) and $b64
}

rule Fileless_PowerShell_Obfuscated {
    meta:
        description = "Obfuscated PowerShell code"
        severity = "high"
    strings:
        $tick = "`" ascii
        $concat = "'+'" ascii
        $replace = "-replace" ascii
        $format = "-f" ascii
        $char = "[char]" ascii
        $join = "-join" ascii
        $split = "-split" ascii
        $reverse = "[array]::reverse" ascii nocase
    condition:
        4 of them
}

rule Fileless_WMIC_Execute {
    meta:
        description = "WMIC process execution"
        severity = "high"
    strings:
        $wmic = "wmic" ascii nocase
        $process = "process" ascii nocase
        $call = "call" ascii nocase
        $create = "create" ascii nocase
        $node = "/node:" ascii nocase
    condition:
        $wmic and $process and $call and $create
}

rule Fileless_MSHTA_Execute {
    meta:
        description = "MSHTA script execution"
        severity = "high"
    strings:
        $mshta = "mshta" ascii nocase
        $vb1 = "vbscript:" ascii nocase
        $vb2 = "javascript:" ascii nocase
        $about = "about:" ascii nocase
        $http = "http" ascii nocase
    condition:
        $mshta and (any of ($vb*) or $about or $http)
}

rule Fileless_Regsvr32_Bypass {
    meta:
        description = "Regsvr32 AppLocker bypass"
        severity = "high"
    strings:
        $reg = "regsvr32" ascii nocase
        $s1 = "/s" ascii nocase
        $n1 = "/n" ascii nocase
        $u1 = "/u" ascii nocase
        $i1 = "/i:" ascii nocase
        $scrobj = "scrobj.dll" ascii nocase
        $http = "http" ascii nocase
    condition:
        $reg and ($scrobj or ($i1 and $http))
}

rule Fileless_Rundll32_Bypass {
    meta:
        description = "Rundll32 execution bypass"
        severity = "high"
    strings:
        $rundll = "rundll32" ascii nocase
        $js1 = "javascript:" ascii nocase
        $vb1 = "vbscript:" ascii nocase
        $shell = "shell32.dll" ascii nocase
        $url = "url.dll" ascii nocase
        $advpack = "advpack.dll" ascii nocase
        $ieadvpack = "ieadvpack.dll" ascii nocase
        $syssetup = "syssetup.dll" ascii nocase
    condition:
        $rundll and (any of ($js*, $vb*) or 2 of ($shell, $url, $advpack, $ieadvpack, $syssetup))
}

rule Fileless_CertUtil_Download {
    meta:
        description = "CertUtil download and decode"
        severity = "high"
    strings:
        $cert = "certutil" ascii nocase
        $url = "-urlcache" ascii nocase
        $split = "-split" ascii nocase
        $decode = "-decode" ascii nocase
        $f = "-f" ascii nocase
        $http = "http" ascii nocase
    condition:
        $cert and (($url and $http) or $decode)
}

rule Fileless_BITSAdmin_Download {
    meta:
        description = "BITSAdmin file transfer"
        severity = "high"
    strings:
        $bits = "bitsadmin" ascii nocase
        $transfer = "/transfer" ascii nocase
        $create = "/create" ascii nocase
        $addfile = "/addfile" ascii nocase
        $resume = "/resume" ascii nocase
        $complete = "/complete" ascii nocase
        $http = "http" ascii nocase
    condition:
        $bits and 2 of ($transfer, $create, $addfile, $resume, $complete) and $http
}

rule Fileless_MSBuild_Execute {
    meta:
        description = "MSBuild inline code execution"
        severity = "high"
    strings:
        $msbuild = "msbuild" ascii nocase
        $task = "<Task>" ascii
        $code = "<Code" ascii
        $inline = "Type=\"Fragment\"" ascii
        $using = "<Using Namespace" ascii
        $reference = "<Reference Include" ascii
    condition:
        $msbuild or (2 of ($task, $code, $inline, $using, $reference))
}

rule Fileless_InstallUtil_Bypass {
    meta:
        description = "InstallUtil AppLocker bypass"
        severity = "high"
    strings:
        $install = "InstallUtil" ascii nocase
        $logfile = "/logfile=" ascii nocase
        $logtoconsole = "/LogToConsole=false" ascii nocase
        $u = "/U" ascii nocase
        $uninstall = "Uninstall" ascii
    condition:
        $install and any of ($logfile, $logtoconsole, $u, $uninstall)
}

rule Fileless_CMSTP_Bypass {
    meta:
        description = "CMSTP UAC bypass"
        severity = "high"
    strings:
        $cmstp = "cmstp" ascii nocase
        $inf = ".inf" ascii nocase
        $s = "/s" ascii nocase
        $au = "/au" ascii nocase
        $runpresetup = "RunPreSetupCommands" ascii
        $registerocx = "RegisterOCXSection" ascii
    condition:
        $cmstp and ($inf or any of ($runpresetup, $registerocx))
}

rule Fileless_WScript_Execute {
    meta:
        description = "WScript/CScript malicious execution"
        severity = "high"
    strings:
        $ws1 = "WScript.Shell" ascii
        $ws2 = "WScript.Network" ascii
        $ws3 = "Scripting.FileSystemObject" ascii
        $run = ".Run" ascii
        $exec = ".Exec" ascii
        $create = "CreateObject" ascii
        $shell = "cmd.exe" ascii nocase
        $ps = "powershell" ascii nocase
    condition:
        any of ($ws*) and $create and ($run or $exec) and ($shell or $ps)
}

rule Fileless_Office_Macro_Execution {
    meta:
        description = "Office macro code execution"
        severity = "high"
    strings:
        $auto1 = "AutoOpen" ascii
        $auto2 = "Auto_Open" ascii
        $auto3 = "Document_Open" ascii
        $auto4 = "Workbook_Open" ascii
        $shell = "Shell" ascii
        $wscript = "WScript.Shell" ascii
        $exec = "CreateObject" ascii
        $cmd = "cmd.exe" ascii nocase
        $ps = "powershell" ascii nocase
    condition:
        any of ($auto*) and (($shell or $wscript) and $exec) and ($cmd or $ps)
}

rule Fileless_DotNet_Reflection {
    meta:
        description = ".NET reflection-based loading"
        severity = "high"
    strings:
        $load1 = "Assembly.Load" ascii
        $load2 = "Assembly.LoadFrom" ascii
        $load3 = "Assembly.LoadFile" ascii
        $load4 = "[Reflection.Assembly]::Load" ascii
        $invoke = "Invoke" ascii
        $entry = "EntryPoint" ascii
        $b64 = "FromBase64String" ascii
    condition:
        any of ($load*) and ($invoke or $entry) and $b64
}

rule Fileless_COM_Hijack {
    meta:
        description = "COM object hijacking"
        severity = "high"
    strings:
        $clsid = "CLSID" ascii
        $inproc = "InprocServer32" ascii
        $local = "LocalServer32" ascii
        $treat = "TreatAs" ascii
        $scripting = "Scripting" ascii
        $wscript = "WScript" ascii
    condition:
        $clsid and (any of ($inproc, $local, $treat)) and any of ($scripting, $wscript)
}

rule Fileless_Scheduled_Task {
    meta:
        description = "Malicious scheduled task creation"
        severity = "high"
    strings:
        $schtasks = "schtasks" ascii nocase
        $create = "/create" ascii nocase
        $run = "/run" ascii nocase
        $tn = "/tn" ascii nocase
        $tr = "/tr" ascii nocase
        $sc = "/sc" ascii nocase
        $ps = "powershell" ascii nocase
        $cmd = "cmd" ascii nocase
        $hidden = "hidden" ascii nocase
    condition:
        $schtasks and ($create or $run) and any of ($ps, $cmd, $hidden)
}

rule Fileless_WMI_Persistence {
    meta:
        description = "WMI event subscription persistence"
        severity = "critical"
    strings:
        $sub1 = "__EventFilter" ascii
        $sub2 = "__EventConsumer" ascii
        $sub3 = "__FilterToConsumerBinding" ascii
        $sub4 = "CommandLineEventConsumer" ascii
        $sub5 = "ActiveScriptEventConsumer" ascii
        $create = "Create" ascii
        $set = "Set" ascii
    condition:
        2 of ($sub*) and ($create or $set)
}

rule Fileless_Registry_Run {
    meta:
        description = "Registry run key persistence"
        severity = "high"
    strings:
        $run1 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" ascii nocase
        $run2 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce" ascii nocase
        $run3 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunServices" ascii nocase
        $run4 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run" ascii nocase
        $cmd = "cmd" ascii nocase
        $ps = "powershell" ascii nocase
        $script = "script" ascii nocase
    condition:
        any of ($run*) and any of ($cmd, $ps, $script)
}
